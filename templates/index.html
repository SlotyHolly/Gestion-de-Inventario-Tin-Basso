{% extends "base.html" %}

{% block content %}
<div class="main-container">
    <div class="main-content">
        <h2>Filtrar Productos</h2>
        <form method="GET" action="{{ url_for('index') }}" class="filter-form">
            <div class="tags-filter">
                {% for tag in tags %}
                <label class="filter-tag {% if tag in selected_tags %}active{% endif %}">
                    <input type="checkbox" name="tag" value="{{ tag }}" 
                    {% if tag in selected_tags %}checked{% endif %}> {{ tag }}
                </label>
                {% endfor %}
            </div>
            <button type="submit" class="button">Aplicar Filtro</button>
        </form>

        <!-- Botones de acción -->
        <h2>Inventario de Productos</h2>
        <div class="button-container">
            <a href="{{ url_for('add_product') }}" class="button">Agregar Producto</a>
            <a href="{{ url_for('manage_tags') }}" class="button">Administrar Tags</a>
        </div>

        <!-- Barra de búsqueda en tiempo real -->
        <input type="text" id="search-input" placeholder="Buscar productos por nombre..." class="search-input">

        <!-- Mostrar productos del inventario -->
        <div id="product-cards-container" class="product-cards-container">
            {% for product in inventario %}
            <div class="product-card">
                <h3>{{ product.nombre }}</h3>
                {% if product.image_url %}
                <img src="{{product.image_url}}" alt="{{ product.nombre }}" class="product-image">
                {% endif %}
                <p><strong>Cantidad:</strong> {{ product.cantidad }}</p>
                <p><strong>Precio:</strong> ${{ product.precio }}</p>
                <p><strong>Tags:</strong> {{ ', '.join(product.tags) }}</p>
                <div class="product-card-actions">
                    <a href="{{ url_for('edit_product', product_id=product.id) }}" class="button">Editar</a>
                    <form action="{{ url_for('delete_product', product_id=product.id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="button-delete">Eliminar</button>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Script para manejar la búsqueda en tiempo real -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Obtener todos los labels con la clase "filter-tag"
        const filterTags = document.querySelectorAll('.filter-tag');

        // Mensaje de depuración para ver cuántos elementos se capturan
        console.log(`Total de etiquetas de filtro encontradas: ${filterTags.length}`);

        // Agregar evento de clic a cada label
        filterTags.forEach(tag => {
            tag.addEventListener('click', function(event) {
                // Evitar la propagación del clic y el comportamiento predeterminado
                event.preventDefault();
                event.stopPropagation();

                // Alternar la clase "active" para cambiar la apariencia del filtro
                this.classList.toggle('active');
                console.log(`Etiqueta clicada: ${this.textContent}, estado activo: ${this.classList.contains('active')}`);

                // Encontrar el checkbox dentro del label y cambiar su estado
                const checkbox = this.querySelector('input[type="checkbox"]');
                checkbox.checked = !checkbox.checked;
            });
        });
    });
    document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const productContainer = document.getElementById('product-cards-container');

    // Escuchar cambios en el campo de búsqueda
    searchInput.addEventListener('input', function() {
        const query = searchInput.value.trim();  // Eliminar espacios en blanco
        console.log('Búsqueda realizada:', query);

        // Hacer una solicitud al backend para obtener los productos filtrados
        fetch(`/search?query=${encodeURIComponent(query)}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Error en la respuesta: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Productos filtrados recibidos:', data);

                // Limpiar el contenedor de productos
                productContainer.innerHTML = '';

                // Verificar si no se encontraron productos
                if (data.length === 0) {
                    productContainer.innerHTML = '<p>No se encontraron productos.</p>';
                } else {
                    // Recorrer los productos devueltos y agregarlos al contenedor
                    data.forEach(product => {
                        const productCard = document.createElement('div');
                        productCard.className = 'product-card';
                        productCard.innerHTML = `
                            <h3>${product.nombre}</h3>
                            ${product.image_url ? `<img src="${product.image_url}" alt="${product.nombre}" class="product-image">` : ''}
                            <p><strong>Cantidad:</strong> ${product.cantidad}</p>
                            <p><strong>Precio:</strong> $${product.precio}</p>
                            <p><strong>Tags:</strong> ${product.tags.join(', ')}</p>
                            <div class="product-card-actions">
                                <a href="/edit/${product.id}" class="button">Editar</a>
                                <form action="/delete/${product.id}" method="POST" style="display:inline;">
                                    <button type="submit" class="button-delete">Eliminar</button>
                                </form>
                            </div>
                        `;
                        productContainer.appendChild(productCard);
                    });
                }
            })
            .catch(error => {
                console.error('Error al realizar la búsqueda:', error);
                productContainer.innerHTML = '<p>Error al realizar la búsqueda. Inténtalo de nuevo más tarde.</p>';
            });
    });
    document.addEventListener('DOMContentLoaded', function() {
        const toggleButton = document.getElementById('toggle-dark-mode');
        
        // Verificar si el usuario ya tiene una preferencia de modo
        if (localStorage.getItem('theme') === 'dark') {
            document.body.classList.add('dark-mode');
        }

        toggleButton.addEventListener('click', function() {
            document.body.classList.toggle('dark-mode');
            toggleButton.textContent = document.body.classList.contains('dark-mode') ? 'Cambiar a modo claro' : 'Cambiar a modo oscuro';
            // Guardar la preferencia del usuario en el almacenamiento local
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });
    });
});
</script>
{% endblock %}
